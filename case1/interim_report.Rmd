---
title: 'Case Study 1: Birth Weight'
author: "Moriah Taylor, Faraz Yashar, AJ Eckmann, Audreya Metz, Naya Chen"
date: "9/10/2019"
output:
  html_document: default
  pdf_document: default
---

```{r, function checking for installed packages, include=FALSE, echo=FALSE}
# Source for function: https://stackoverflow.com/questions/9341635/check-for-installed-packages-before-running-install-packages
pkgTest <- function(x)
  {
    if (!require(x,character.only = TRUE))
    {
      install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
        if(!require(x,character.only = TRUE)) stop("Package not found")
    }
  }
```

```{r, echo= FALSE, cache=TRUE, include=FALSE}
# Load any necessary packages here
pkgTest("tidyr")
pkgTest("dplyr")
pkgTest("purrr")
pkgTest("tidyverse")
pkgTest("broom")
pkgTest("hashmap")
pkgTest("leaps")
pkgTest("MASS")
library(tidyr)
library(dplyr)
library(purrr)
library(tidyverse)
library(broom)
library(hashmap)
library(leaps)
library(MASS)
```

```{r, echo=FALSE, cache=TRUE}
set.seed(20190908)
```

```{r, echo=FALSE, cache=TRUE}
# read in birth data with NAs
o_data = read.csv("data/Yr1116Birth.csv", na.strings=c("9","99", "9999"))

```

```{r, echo=FALSE, cache=TRUE}
# Helper functions
mean_sd_txt = function(x, digits = 0) {
  paste0(round(mean(x), digits = digits), "±", round(sd(x), digits = digits))
}
```

```{r, echo=FALSE, cache=TRUE}
# remove missing rows
birth_data = na.omit(o_data)

# convert to categorical variables
# SEX, CORES(residence), MRACER(race), MHISP(Hispanic origin)
birth_data = birth_data %>% mutate(
  YOB = as.factor(YOB),
  SEX = as.factor(SEX),
  CORES = as.factor(CORES),
  MRACER = as.factor(MRACER),
  MHISP = as.factor(MHISP),
)

# function to convert numeric values to two-level categorical variables
# based on threshold
transform = function(data, cols, threshold) {
  for (i in 1:length(cols)) {
    col = cols[i]
    data[paste0(col, 'BIN')] = as.factor(
      case_when(
        data[col] <= threshold ~ 0,
        data[col] > threshold ~ 1,
      )
    )
  }
  return(data)
}

# convert average #cig to categorical: smoke or not smoke
birth_data = transform(birth_data, c("CIGPN", "CIGFN", "CIGSN", "CIGLN"), 0)
# convert #pregancy to categorical: pregnant before or never
birth_data = transform(birth_data, c("PARITY"), 1)

birth_data$SMOKER = (as.numeric(birth_data$CIGPNBIN) - 1) | # Before pregnancy
  (as.numeric(birth_data$CIGPNBIN) - 1) | # First trimester
  (as.numeric(birth_data$CIGPNBIN) - 1) | # Second trimester
  (as.numeric(birth_data$CIGPNBIN) - 1)   # Last trimester

# Combine all low frequency groups to other
birth_data$RACE = as.character(birth_data$MRACER)
birth_data$RACE[birth_data$RACE == "0"] = "O"
birth_data$RACE[birth_data$RACE == "1"] = "W"
birth_data$RACE[birth_data$RACE == "2"] = "B"
birth_data$RACE[birth_data$RACE == 3] = "O" # Native americans -> other
birth_data$RACE[birth_data$RACE == 4] = "A"
birth_data$RACE[birth_data$RACE == 5] = "A"
birth_data$RACE[birth_data$RACE == 6] = "A"
birth_data$RACE[birth_data$RACE == 7] = "A"
birth_data$RACE[birth_data$RACE == 8] = "A"
birth_data$RACE = as.factor(birth_data$RACE)
birth_data$RACE = relevel(birth_data$RACE, ref="W")

# 0 - Other non-White
# 1 - White
# 2 - Black or African American
# 3 - American Indian or Alaska Native
# 4 - Chinese
# 5 - Japanese
# 6 - Native Hawaiian
# 7 - Filipino
# 8 - Other Asian

# Separate hispanic and nonhispanic
birth_data$HISP = as.character(birth_data$MHISP)
birth_data$HISP[birth_data$HISP == "C"] = "Y"
birth_data$HISP[birth_data$HISP == "M"] = "Y"
birth_data$HISP[birth_data$HISP == "N"] = "N"
birth_data$HISP[birth_data$HISP == "O"] = "Y"
birth_data$HISP[birth_data$HISP == "P"] = "Y"
birth_data$HISP[birth_data$HISP == "S"] = "Y"
birth_data$HISP[birth_data$HISP == "U"] = "Y"
birth_data$HISP = birth_data$HISP == "Y"
```



### **0  Exploratory Analysis**
```{r, cache=TRUE, echo= FALSE}
#[analysis: unnatural gestational time (80 weeks) found in the plot -> record error -> remove data point; MORE analysis based on the plots]
ggplot(birth_data, aes(GEST, BWTG)) +
  geom_point(aes(col=SMOKER), size=1, shape=2) +
  facet_wrap(~SMOKER, labeller = labeller(SMOKER=c("TRUE"="smoker", "FALSE"="non-smoker"))) +
  ggtitle("Birth Weight vs. Gestation Time for Non-smokers and Smokers")

ggplot(birth_data, aes(x=BWTG)) +
  geom_histogram(aes(y = ..density.., fill=SMOKER), color="grey", alpha=0.7) +
  stat_function(fun = dnorm, args = list(mean = mean(birth_data$BWTG), sd = sd(birth_data$BWTG))) +
  geom_vline(xintercept = mean(birth_data$BWTG), linetype="dashed") +
  facet_wrap(~SMOKER, labeller = labeller(
    SMOKER = c(
      "TRUE"=paste("Smoker ", mean_sd_txt((birth_data %>% filter(SMOKER == TRUE))$BWTG)),
      "FALSE"=paste("Non-smoker", mean_sd_txt((birth_data %>% filter(SMOKER == FALSE))$BWTG))))) +
  ggtitle("Birth Weight Distribution for Non-smokers and Smokers")
```

### **1  Data Cleaning and Modifications**

A normal pregnancy ranges from 38 to 42 weeks. (Source: https://medlineplus.gov/ency/article/002367.htm)

We note a gestational age nearly double that time at 80. We will remove the entry with that value since we consider it a clerical error.

```{r, echo=FALSE, cache=TRUE}
# remove the data point with more than 80 weeks gestational age 
birth_data = birth_data %>% filter(GEST < 50)
```

Next we examine the data to determine if any of the covariates vary with year of birth.

```{r, echo=FALSE, cache=TRUE, include=FALSE}
birth_data %>% group_by(YOB) %>% summarize(
  GEST = mean_sd_txt(GEST, 1),
  BWTG = mean_sd_txt(BWTG, 1),
  SMOKER = round(mean(SMOKER == TRUE), 2),
  SEX = round(mean(SEX == 1), 2),
  MAGE = mean_sd_txt(MAGE, 1),
  PLUR = mean_sd_txt(PLUR, 1),
  PARITY = mean_sd_txt(PARITY, 1),
  MRACER0 = round(mean(MRACER == 0), 3),
  MRACER1 = round(mean(MRACER == 1), 3),
  MRACER2 = round(mean(MRACER == 2), 3),
  MRACER3 = round(mean(MRACER == 3), 3),
  MRACER4 = round(mean(MRACER == 4), 3),
)
```

When inspecting the mean and variance covariates by year of birth, the values remain relatively stable aside from smoker status which decreases slightly by a few percentage points. This suggests that smoking rates dropped over time across the other covariates and therefore, we believe that there is not an interfering time-related trend and that year of birth is not a covariate of interest.

#### *Modeling Part 1: Ordinary Least Squares*

As a starting point, we produced a full model using binarized smoking and parity covariate.

```{r, echo=FALSE, cache=TRUE, include=FALSE}
fullmodel_naya = lm(BWTG~SEX + CORES + CIGPNBIN + CIGFNBIN + CIGSNBIN + CIGLNBIN + GEST + PLUR + MAGE + MRACER + MHISP + PARITYBIN, data=birth_data)
summary(fullmodel_naya)
fullmodel_naya = broom::tidy(fullmodel_naya)
```
Since a full model has far too many variables, we drop those with p-values larger than a threshold value as the first step. We set the threshold value to 0.01 here.

```{r, echo=FALSE, cache=TRUE, include=FALSE}
# select variables with p-value below a threshold value
pthreshold = 0.01
used_index = which(fullmodel_naya$p.value[-1] < pthreshold)
used_vars = fullmodel_naya$term[used_index]

get.used.data =  function(used_vars) {
    levels_map = list()
    for (var in used_vars) {
      level = str_extract(var, "[0-9]+")
      if (!is.na(level)) {
        original = sub("[0-9]+", "", var)
        if (is.null(levels_map[[original]])) {
          levels_map[[original]] = c()
        }
        levels_map[[original]] = c(levels_map[[original]], level)
      }
      if (!is.na(str_extract(var, "MHISP"))) {
        if (is.null(levels_map[["MHISP"]])) {
          levels_map[["MHISP"]] = c()
        }
        levels_map[["MHISP"]] = sub("MHISP([M|N|O|P|S|U])", "\\1", var)
      }
    }
    original_vars = unique(sub("MHISP.*", "MHISP", sub("[0-9]+", "", used_vars)))
    
    used_data = birth_data[, which(names(birth_data) %in% c(original_vars, "BWTG"))]
    for (colname in colnames(used_data)) {
      # select levels with p-value larger than the threshold
      if (is.factor(used_data[[colname]])) {
        used_data[[colname]] = factor(used_data[[colname]], levels = c(levels(birth_data[[colname]])[1], levels_map[[colname]]))
        used_data[[colname]][is.na(used_data[[colname]])] = levels(birth_data[[colname]])[1]
      }
    }
    return(used_data)
}

used_data = get.used.data(used_vars)
model2_naya = lm(BWTG ~ ., data = used_data)
summary(model2_naya)
```

```{r, echo=FALSE, cache=TRUE, include=FALSE}
step(model2_naya, direction = "backward")
```

The function **regsubsets** in the leaps package selects a subset of variables of fixed size by comparing R^2^ for all combinations of variables. The function chose GEST, MRACER1, CIGLN1, PLUR, MAGE, CIGFN1, MRACER3, CORES26 as the eight most significant variables (from the most to least significant, respectively). All of these variables have p-values < 2e-16. Based on the exploratory work done by **regsubsets**, we use these variables as predictors for now.
```{r, echo=FALSE, cache=TRUE, include=FALSE}
regfit_backward <- leaps::regsubsets(BWTG ~ ., data = used_data, 
                              method="backward")
summary(regfit_backward)
```

```{r, echo=FALSE, cache=TRUE, include=FALSE}
used_vars = c("GEST", "MRACER1", "CIGLNBIN1", "PLUR", "MAGE", "CIGFNBIN1", "MRACER3", "CORES26")
used_data = get.used.data(used_vars)
finalols <- lm(BWTG ~ GEST+MRACER+CIGLNBIN+PLUR+MAGE+CIGFNBIN+CORES, data = used_data)
summary(finalols)
```
#### *Interpretation of OLS Model*

The baseline for this regression model is a non-smoking mother, with a race of "other non-White", who had a non-plural birth, and was born outside of Cumberland county. If we assume the gestation period was 40 weeks and the mother's age is 26 years, we could expect the baseline child to weigh 3,792.4 grams. 

Assuming all else is held constant:

For every one-week increase in gestation, we can expect birth weight to increase by 175.0 grams on average. If the mother smoked during the infant's last trimester, we can expect the infant's birthweight to decrease 137.1 grams on average. For every additional baby born during the birth (in cases of plurality, such as twins and triplets), we can expect the baby's birth weight to decrease by 340.6 grams on average. For every one-year increase in the mother's age, we can expect the baby's birth weight to increase 7.9 grams. If the mother smoked during the first three months of the pregnancy, we can expect birthweight to decrease 84.53 grams on average. If the child is born in Cumberland County, it will be born 21.0 grams heavier than if it had been born outside of Cumberland, on average. If the child is white, we can expect its weight to be 139.5 grams heavier than an "other (non-White)" baby on average, and if the child is American Indian or Alaskan, we can expect its weight to be 71.07 grams heavier than an "other (non-White)" baby on average. 

### **2 Model Validation**
```{r, echo=FALSE, cache=TRUE}
# Diagonostic plots examining residuals, fitted values, Cook’s distance, and leverage
par(mfrow=c(2,2))
plot(finalols)
```

#### *Modeling Part 2: Refitting using Robust Regression*
We observed points of high leverage and influence from the diagnostic plots. We have decided that these data points are not data entry errors, neither are they from a different population than most of our data. Hence, we have no compelling reason to exclude them from the analysis. Robust regression might be a good strategy since it is a compromise between excluding these points entirely from the analysis and including all the data points and treating all them equally in OLS regression. The idea of robust regression is to weigh the observations differently based on how well-behaved these observations are. Roughly speaking, it is a form of weighted and reweighted least squares regression.
```{r, echo=FALSE, cache=TRUE, include=FALSE}
#creating a robust model
robustmodel <- rlm(BWTG ~ GEST+MRACER+CIGLNBIN+PLUR+MAGE+CIGFNBIN+CORES, data = used_data)
summary(robustmodel)
```


#### *Interpretation of Robust Regression* 

Using the same baseline conditions as the OLS model, a child with a gestation of 40 weeks and a mother aged 26 years, would be expected to weighh 3,767.4 grams. 

Assuming all else is held constant:

For every one-week increase in gestation, we can expect birth weight to increase by 177.96 grams on average. If the mother smoked during the infant's last trimester, we can expect the infant's birthweight to decrease 135.7 grams on average. For every additional baby born during the birth (in cases of plurality, such as twins and triplets), we can expect the baby's birth weight to decrease by 323.25 grams on average. For every one year increase in the mother's age, we can expect the baby's birth weight to increase 7.73 grams. If the mother smoked during the first three months of the pregnancy, we can expect birthweight to decrease 83.98 grams on average. If the child is born in Cumberland County, it will be born 21.76 grams heavier than if it had been born outside of this county, on average. If the child is white, we can expect its weight to be 141.45 grams heavier than an "other (non-White)" baby on average, and if the child is American Indian or Alaskan, we can expect its weight to be 86.04 grams heavier than an "other (non-White)" baby on average. 


It seems the result from robust regression does not differ too much from the result from OLS regression. We will explore this further.


### **3 Model Comparison**

In analyzing the two models, there seems to be significant issues with heteroskedasticity. As expected, there is a lower residual error with  robust regression.

```{r, echo=FALSE, cache=TRUE}
par(mfrow=c(2,2))
plot(finalols, las=1)
mtext("OLS Model", outer = TRUE, cex = 1.5)

par(mfrow=c(2,2))
plot(robustmodel, las=1)
mtext("Robust Model", outer = TRUE, cex = 1.5)
```

### **4 Impact of Maternal Smoking**

Both the OLS model and the robust regression model indicate an increase in birth weight via the elimination of maternal smoking.

The OLS model estimates that eliminating maternal smoking in the first trimester predicts an increase of 83.98 grams in the birth weight of a child and eliminating maternal smoking in the last trimester predicts an increase of 135.79 grams in birth weight.

The robust model estimates that eliminating maternal smoking in the first trimester predicts an increase of 83.98 grams (SD = 3.24) in the birth weight of a child and eliminating maternal smoking in the last trimester predicts an increase of 135.79 grams (SD = 3.58) in birth weight.