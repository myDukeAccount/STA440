---
title: 'Case Study 1: Birth Weight'
author: "Moriah Taylor, Faraz Yashar, AJ Eckmann, Audreya Metz, Naya Chen"
date: "9/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, function checking for installed packages, include=FALSE, echo=FALSE}
# Source for function: https://stackoverflow.com/questions/9341635/check-for-installed-packages-before-running-install-packages
pkgTest <- function(x)
  {
    if (!require(x,character.only = TRUE))
    {
      install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
        if(!require(x,character.only = TRUE)) stop("Package not found")
    }
  }
```

```{r}
# Load any necessary packages here
pkgTest("tidyr")
pkgTest("dplyr")
pkgTest("purrr")
pkgTest("tidyverse")
pkgTest("broom")
pkgTest("hashmap")
pkgTest("leaps")
pkgTest("MASS")
library(tidyr)
library(dplyr)
library(purrr)
library(tidyverse)
library(broom)
library(hashmap)
library(leaps)
library(MASS)
```

```{r}
# read in birth data with NAs
o_data = read.csv("data/Yr1116Birth.csv", na.strings=c("9","99", "9999"))
```

```{r}
# remove missing rows
birth_data = na.omit(o_data)

# convert to categorical variables
# SEX, CORES(residence), MRACER(race), MHISP(Hispanic origin)
birth_data = birth_data %>% mutate(
  YOB = as.factor(YOB),
  SEX = as.factor(SEX),
  CORES = as.factor(CORES),
  MRACER = as.factor(MRACER),
  MHISP = as.factor(MHISP),
)

# function to convert numeric values to two-level categorical variables
# based on threshold
transform = function(data, cols, threshold) {
  for (i in 1:length(cols)) {
    col = cols[i]
    data[col] = as.factor(
      case_when(
        data[col] <= threshold ~ 0,
        data[col] > threshold ~ 1,
      )
    )
  }
  return(data)
}

# convert average #cig to categorical: smoke or not smoke
birth_data = transform(birth_data, c("CIGPN", "CIGFN", "CIGSN", "CIGLN"), 0)
# convert #pregancy to categorical: pregnant before or never
birth_data = transform(birth_data, c("PARITY"), 1)
glimpse(birth_data)
```


## Exploratory Analysis
[analysis: unnatural gestational time(80 weeks) found in the plot -> record error -> remove data point; MORE analysis based on the plots]
```{r}
ggplot(birth_data, aes(GEST, BWTG)) +
  geom_point(aes(col=CIGPN), size=1, shape=2) +
  facet_wrap(~CIGPN, labeller = labeller(CIGPN=c("1"="smoke", "0"="not smoke"))) +
  ggtitle("Birth Weight vs. Gestation Time for Non-smokers and Smokers")

ggplot(birth_data, aes(x=BWTG)) +
  geom_histogram(aes(y = ..density.., fill=CIGPN), color="grey", alpha=0.7) +
  stat_function(fun = dnorm, args = list(mean = mean(birth_data$BWTG), sd = sd(birth_data$BWTG))) +
  geom_vline(xintercept = mean(birth_data$BWTG), linetype="dashed") +
  facet_wrap(~CIGPN, labeller = labeller(CIGPN=c("1"="smoke", "0"="not smoke"))) +
  ggtitle("Birth Weight Distribution for Non-smokers and Smokers")
```

# Clean data
```{r}
# remove the data point with more than 80 weeks gestational age 
birth_data = birth_data %>% filter(GEST < 50)
```

### Modeling

```{r}
fullmodel = lm(BWTG~., data=birth_data)
fullmodel = broom::tidy(fullmodel)
```

Since full model has too many variables, we drop the variables with p-values larger than a threshold value as the first step. We set the threshold value to 0.01 here.
```{r}
# select variables with p-value below a threshold value
pthreshold = 0.01
used_index = which(fullmodel$p.value[-1] < pthreshold)
used_vars = fullmodel$term[used_index]

get.used.data =  function(used_vars) {
    levels_map = list()
    for (var in used_vars) {
      level = str_extract(var, "[0-9]+")
      if (!is.na(level)) {
        original = sub("[0-9]+", "", var)
        if (is.null(levels_map[[original]])) {
          levels_map[[original]] = c()
        }
        levels_map[[original]] = c(levels_map[[original]], level)
      }
      if (!is.na(str_extract(var, "MHISP"))) {
        if (is.null(levels_map[["MHISP"]])) {
          levels_map[["MHISP"]] = c()
        }
        levels_map[["MHISP"]] = sub("MHISP([M|N|O|P|S|U])", "\\1", var)
      }
    }
    original_vars = unique(sub("MHISP.*", "MHISP", sub("[0-9]+", "", used_vars)))
    
    used_data = birth_data[, which(names(birth_data) %in% c(original_vars, "BWTG"))]
    for (colname in colnames(used_data)) {
      # select levels with p-value larger than the threshold
      if (is.factor(used_data[[colname]])) {
        used_data[[colname]] = factor(used_data[[colname]], levels = c(levels(birth_data[[colname]])[1], levels_map[[colname]]))
        used_data[[colname]][is.na(used_data[[colname]])] = levels(birth_data[[colname]])[1]
      }
    }
    return(used_data)
}

used_data = get.used.data(used_vars)
model2 = lm(BWTG ~ ., data = used_data)
summary(model2)
```

```{r}
step(model2, direction = "backward")
```

The function regsubsets in leaps package select the subset of variables of fixed size by comparing $R^2$ for all combinations of variables. 
```{r}
regfit_backward <- leaps::regsubsets(BWTG ~ ., data = used_data, 
                              method="backward")
summary(regfit_backward)
```

The function regsubsets chooses GEST, MRACER1, CIGLN1, PLUR, MAGE, CIGFN1, MRACER3, CORES26 as the eight most significant variables(from the most significant to least significant). Based on the exploratory work done by regsubsets, we will use these variables as the predictors for now.
```{r}
used_vars = c("GEST", "MRACER1", "CIGLN1", "PLUR", "MAGE", "CIGFN1", "MRACER3", "CORES26")
used_data = get.used.data(used_vars)
finalmodel <- lm(BWTG ~ GEST+MRACER+CIGLN+PLUR+MAGE+CIGFN+CORES, data = used_data)
summary(finalmodel)
```

```{r}
par(mfrow=c(2,2))
plot(finalmodel)
```

